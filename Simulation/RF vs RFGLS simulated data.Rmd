---
title: "RF vs RFGLS simulated data"
author: "Georgios Pnigouras"
date: "2025-05-11"
output: html_document
---


```{r}
library(gstat)
library(raster)
library(sf)
library(spdep)
library(randomForest)
library(RandomForestsGLS)
library(dplyr)
library(tidyr)



domain_poly <- st_as_sf(
  st_sfc(st_polygon(list(matrix(c(
    0,0, 100,0, 100,100, 0,100, 0,0
  ), ncol=2, byrow=TRUE))))
)
r        <- raster(ncols=200, nrows=200, xmn=0, xmx=100, ymn=0, ymx=100)
grid_pts <- st_as_sf(rasterToPoints(r, spatial=TRUE))

param_list <- list(
  list(psill=0.1, range=0.1, sd_nug=1),
  list(psill=1.7, range=4, sd_nug=0.1),
  list(psill=1.7, range=8,      sd_nug=0.1),
  list(psill=1.7, range=40,      sd_nug=0.1)
)


# (re)define your domain, grid_pts, and param_list as before…

# Prepare an outer list to collect 100-rep results for each parameter set
all_results <- vector("list", length(param_list))

for(i in seq_along(param_list)) {
  params   <- param_list[[i]]
  psill    <- params$psill
  rho      <- params$range
  sd_nug   <- params$sd_nug

  # Prepare a data.frame to hold 100 rows (one per replicate)
  rep_df <- data.frame(
    rep        = 1:100,
    Moran_I    = NA_real_,
    MSE_RF     = NA_real_,
    MSE_RFGLS  = NA_real_,
    MISE_RF    = NA_real_,
    MISE_RFGLS = NA_real_
  )

  for(rep in 1:100) {
    set.seed(1000 + i*100 + rep)

    # --- simulate as before ---
    matern_model <- vgm("Mat", psill=psill, range=rho, nugget=0, kappa=1.5)
    g            <- gstat(formula=z~1, dummy=TRUE, beta=0,
                          model=matern_model, nmax=50)
    cov_sims     <- predict(g, grid_pts, nsim=4) %>% as.data.frame()
    X1 <- cov_sims$sim1; X2 <- cov_sims$sim2; X3 <- cov_sims$sim3
    det_part <- sin(X1/10) + 2*log(abs(X2)+1) + 0.3*X2*X3
    error_sim<- cov_sims$sim4
   
     Y        <- det_part + error_sim + rnorm(length(det_part), sd=sd_nug)
     cov_rasters <- stack(
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X1)),
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X2)),
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X3))
    )
    out_rast <- rasterFromXYZ(cbind(st_coordinates(grid_pts), Y))
    names(out_rast) <- "Y"
    all_stack      <- stack(out_rast, cov_rasters)

    # 2b. Sample train/test
    train_pts <- st_sample(domain_poly, 400)
    test_pts  <- st_sample(domain_poly, 100)
    coords_train <- st_coordinates(train_pts)
    coords_test  <- st_coordinates(test_pts)

    train_df <- as.data.frame(raster::extract(all_stack, coords_train))
    test_df  <- as.data.frame(raster::extract(all_stack, coords_test))


    # Moran’s I
    nb        <- knn2nb(knearneigh(coords_train, k = 20))

    lw        <- nb2listw(nb, style="W")
    rep_df$Moran_I[rep] <- moran.test(train_df$Y, lw)$estimate[1]

  
    # Plain RF
    rf_model        <- randomForest(x=train_df[,c("X1","X2","X3")],
                                    y=train_df$Y, ntree=100)
    rep_df$MSE_RF[rep] <- mean((test_df$Y - predict(rf_model, test_df))^2)

    # RF-GLS
    rfgls_model     <- RFGLS_estimate_spatial(
      coords      = coords_train,
      y           = train_df$Y,
      X           = as.matrix(train_df[,c("X1","X2","X3")]),
      ntree       = 100,
      cov.model   = "matern",
      n.neighbors = 20,
      nu          = 1.5,
      sigma.sq    = psill,
      tau.sq      = sd_nug,
      phi         = 1/rho,
      verbose     = TRUE,h=15
    )
    rfgls_pred <- RFGLS_predict_spatial(rfgls_model, coords_test,
                                        as.matrix(test_df[,c("X1","X2","X3")]))$prediction
    rep_df$MSE_RFGLS[rep] <- mean((test_df$Y - rfgls_pred)^2)

    # Estimation MISE
    est_df <- data.frame(X1, X2, X3, true_mean=det_part)
    rep_df$MISE_RF[rep]    <- mean((predict(rf_model,    est_df) - est_df$true_mean)^2)
    rep_df$MISE_RFGLS[rep] <- mean((RFGLS_predict(rfgls_model, as.matrix(est_df[,1:3]))$predicted
                                    - est_df$true_mean)^2)
  }

  

  
  
  
  
  
  # Store scenario ID + parameters with the 50-rep data
  all_results[[i]] <- rep_df %>%
    mutate(
      set   = i,
      psill = psill,
      range = rho,
      sd_nug= sd_nug
    )
}

# Combine into one long data.frame
final_df <- bind_rows(all_results)



# gather MSE metrics into long form
mse_long <- tidyr::pivot_longer(
  dplyr::select(final_df,
                set, psill, range, sd_nug, rep, MSE_RF, MSE_RFGLS),
  cols      = c(MSE_RF, MSE_RFGLS),
  names_to  = "method",
  values_to = "MSE"
)


mse_long <- final_df %>%
  select(set, psill, range, sd_nug, rep, MSE_RF, MSE_RFGLS) %>%
  pivot_longer(cols = c(MSE_RF, MSE_RFGLS),
               names_to = "method", values_to = "MSE")



# Same for MISE:
mise_long <- final_df %>%
  select(set, psill, range, sd_nug, rep, MISE_RF, MISE_RFGLS) %>%
  pivot_longer(cols = c(MISE_RF, MISE_RFGLS),
               names_to = "method", values_to = "MISE")
mise_long <- tidyr::pivot_longer(
  dplyr::select(final_df,
                set, psill, range, sd_nug, rep, MISE_RF, MISE_RFGLS),
  cols       = c(MISE_RF, MISE_RFGLS),
  names_to   = "method",
  values_to  = "MISE"
)


# Create a scenario label (same for MSE and MISE datasets)
mse_long <- mse_long %>%
  mutate(scenario = paste0("Set ", set, "\n(psill=", psill, ", range=", range, ")"))

mise_long <- mise_long %>%
  mutate(scenario = paste0("Set ", set, "\n(psill=", psill, ", range=", range, ")"))

# --- MSE boxplot ---
p_mse <- ggplot(mse_long, aes(x = scenario, y = MSE, fill = method)) +
  geom_boxplot(alpha = 0.7, outlier.size = 1) +
  theme_minimal(base_size = 14) +
  labs(
    title = "MSE Comparison by Hyperparameter Set",
    x = "Hyperparameter Set",
    y = "Mean Squared Error",
    fill = "Method"
  )

# --- MISE boxplot ---
p_mise <- ggplot(mise_long, aes(x = scenario, y = MISE, fill = method)) +
  geom_boxplot(alpha = 0.7, outlier.size = 1) +
  theme_minimal(base_size = 14) +
  labs(
    title = "MISE Comparison by Hyperparameter Set",
    x = "Hyperparameter Set",
    y = "Mean Integrated Squared Error",
    fill = "Method"
  )

# Show in R
p_mse
p_mise


```














