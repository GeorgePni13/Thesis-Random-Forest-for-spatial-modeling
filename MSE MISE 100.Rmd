---
title: "Untitled"
author: "Georgios Pnigouras"
date: "2025-05-11"
output: html_document
---

```{r}


# ————————————————————————————————————————————————
# 0. Setup domain, grid, params, and results container
# ————————————————————————————————————————————————
library(gstat); library(raster); library(sf)
library(randomForest); library(RandomForestsGLS); library(spdep)
library(ggplot2); library(viridis)

domain_poly <- st_as_sf(
  st_sfc(st_polygon(list(matrix(c(
    0,0, 100,0, 100,100, 0,100, 0,0
  ), ncol=2, byrow=TRUE))))
)
r        <- raster(ncols=200, nrows=200, xmn=0, xmx=100, ymn=0, ymx=100)
grid_pts <- st_as_sf(rasterToPoints(r, spatial=TRUE))

param_list <- list(
  list(psill=4*0.43, range=4, sd_nug=0.8),
  list(psill=4*0.43, range=8,      sd_nug=0.8),
  list(psill=4*0.43, range=40,      sd_nug=0.8)
)

results <- data.frame(
  set         = integer(),
  psill       = double(),
  range       = double(),
  sd_nug      = double(),
  Moran_I     = double(),
  MSE_RF      = double(),
  MSE_RFGLS   = double(),
  MISE_RF     = double(),
  MISE_RFGLS  = double(),
  stringsAsFactors = FALSE
)

# ————————————————————————————————————————————————
# 1. Outer loop over hyperparameter sets
# ————————————————————————————————————————————————
for(i in seq_along(param_list)) {
  params <- param_list[[i]]
  psill  <- params$psill
  rho    <- params$range
  sd_nug <- params$sd_nug

  # Prepare accumulators for 20 replicates
  morans   <- numeric(20)
  mses_rf      <- numeric(20)
  mses_rfgls   <- numeric(20)
  mises_rf     <- numeric(20)
  mises_rfgls  <- numeric(20)

  # ————————————————————————————————————————————————
  # 2. Inner loop: 20 replicates
  # ————————————————————————————————————————————————
  for(rep in 1:20) {
    # 2a. Simulate fields & outcome (exactly as before)
    matern_model <- vgm(model="Mat", psill=psill, range=rho, nugget=0, kappa=1.5)
    g            <- gstat(formula=z~1, dummy=TRUE, beta=0, model=matern_model, nmax=50)
    cov_sims     <- predict(g, grid_pts, nsim=4)
    cov_df       <- as.data.frame(cov_sims)
    X1           <- cov_df$sim1
    X2           <- cov_df$sim2
    X3           <- cov_df$sim3
    det_part     <- sin(X1/10) + 2*log(abs(X2)+1) + 0.3 * X2 * X3
    error_sim    <- cov_df$sim4
    Y            <- det_part + error_sim + rnorm(nrow(cov_df), sd=sd_nug)

    # Build rasters and stack
    cov_rasters <- stack(
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X1)),
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X2)),
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X3))
    )
    out_rast <- rasterFromXYZ(cbind(st_coordinates(grid_pts), Y))
    names(out_rast) <- "Y"
    all_stack      <- stack(out_rast, cov_rasters)

    # 2b. Sample train/test
    train_pts <- st_sample(domain_poly, 400)
    test_pts  <- st_sample(domain_poly, 100)
    coords_train <- st_coordinates(train_pts)
    coords_test  <- st_coordinates(test_pts)

    train_df <- as.data.frame(raster::extract(all_stack, coords_train))
    test_df  <- as.data.frame(raster::extract(all_stack, coords_test))

    # 2c. Moran's I
    nb        <- knn2nb(knearneigh(coords_train, k=20))
    lw        <- nb2listw(nb, style="W")
    morans[rep] <- moran.test(train_df$Y, lw)$estimate[1]

    # 2d. Fit plain RF
    rf_model   <- randomForest(
      x          = train_df[,c("X1","X2","X3")],
      y          = train_df$Y,
      ntree      = 100,
      keep.forest=TRUE
    )
    rf_pred    <- predict(rf_model, test_df[,c("X1","X2","X3")])
    mses_rf[rep] <- mean((test_df$Y - rf_pred)^2)

    # 2e. Fit RF-GLS
    rfgls_model <- RFGLS_estimate_spatial(
      coords       = coords_train,
      y            = train_df$Y,
      X            = as.matrix(train_df[,c("X1","X2","X3")]),
      ntree        = 100,
      cov.model    = "matern",
      n.neighbors  = 20,
      nu=1.5, sigma.sq = params$psill , tau.sq = params$sd_nug, phi= 1/params$range ,
      verbose      = TRUE, h=15
    )
    rfgls_pred   <- RFGLS_predict_spatial(
      rfgls_model,
      coords_test,
      as.matrix(test_df[,c("X1","X2","X3")])
    )$prediction
    mses_rfgls[rep] <- mean((test_df$Y - rfgls_pred)^2)

    # 2f. Estimation MISE
    # True mean over full grid:
    est_df       <- data.frame(
      X1         = cov_df$sim1,
      X2         = cov_df$sim2,
      X3         = cov_df$sim3,
      true_mean  = det_part
    )
    rf_est       <- predict(rf_model,    est_df[,c("X1","X2","X3")])
    rfgls_est    <- RFGLS_predict(
                      rfgls_model,
                      as.matrix(est_df[,c("X1","X2","X3")])
                    )$predicted
    mises_rf[rep]    <- mean((rf_est    - est_df$true_mean)^2)
    mises_rfgls[rep] <- mean((rfgls_est - est_df$true_mean)^2)
  }

  # ————————————————————————————————————————————————
  # 3. After 20 replicates, compute averages
  # ————————————————————————————————————————————————
  results <- rbind(
    results,
    data.frame(
      set        = i,
      psill      = psill,
      range      = rho,
      sd_nug     = sd_nug,
      Moran_I    = mean(morans),
      MSE_RF     = mean(mses_rf),
      MSE_RFGLS  = mean(mses_rfgls),
      MISE_RF    = mean(mises_rf),
      MISE_RFGLS = mean(mises_rfgls),
      stringsAsFactors = FALSE
    )
  )
}

# 4. View final averaged results
print(results)


```

```{r}
library(gstat)
library(raster)
library(sf)
library(spdep)
library(randomForest)
library(RandomForestsGLS)
library(dplyr)
library(tidyr)



domain_poly <- st_as_sf(
  st_sfc(st_polygon(list(matrix(c(
    0,0, 100,0, 100,100, 0,100, 0,0
  ), ncol=2, byrow=TRUE))))
)
r        <- raster(ncols=200, nrows=200, xmn=0, xmx=100, ymn=0, ymx=100)
grid_pts <- st_as_sf(rasterToPoints(r, spatial=TRUE))

param_list <- list(
  list(psill=0.7, range=4, sd_nug=0.6),
  list(psill=0.7, range=8,      sd_nug=0.6),
  list(psill=0.7, range=40,      sd_nug=0.6)
)


# (re)define your domain, grid_pts, and param_list as before…

# Prepare an outer list to collect 50-rep results for each parameter set
all_results <- vector("list", length(param_list))

for(i in seq_along(param_list)) {
  params   <- param_list[[i]]
  psill    <- params$psill
  rho      <- params$range
  sd_nug   <- params$sd_nug

  # Prepare a data.frame to hold 50 rows (one per replicate)
  rep_df <- data.frame(
    rep        = 1:20,
    Moran_I    = NA_real_,
    MSE_RF     = NA_real_,
    MSE_RFGLS  = NA_real_,
    MISE_RF    = NA_real_,
    MISE_RFGLS = NA_real_
  )

  for(rep in 1:20) {
    set.seed(1000 + i*100 + rep)

    # --- simulate as before ---
    matern_model <- vgm("Mat", psill=psill, range=rho, nugget=0, kappa=1.5)
    g            <- gstat(formula=z~1, dummy=TRUE, beta=0,
                          model=matern_model, nmax=50)
    cov_sims     <- predict(g, grid_pts, nsim=4) %>% as.data.frame()
    X1 <- cov_sims$sim1; X2 <- cov_sims$sim2; X3 <- cov_sims$sim3
    det_part <- sin(X1/10) + 2*log(abs(X2)+1) + 0.3*X2*X3
    error_sim<- cov_sims$sim4
   
     Y        <- det_part + error_sim + rnorm(length(det_part), sd=sd_nug)
     cov_rasters <- stack(
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X1)),
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X2)),
      rasterFromXYZ(cbind(st_coordinates(grid_pts), X3))
    )
    out_rast <- rasterFromXYZ(cbind(st_coordinates(grid_pts), Y))
    names(out_rast) <- "Y"
    all_stack      <- stack(out_rast, cov_rasters)

    # 2b. Sample train/test
    train_pts <- st_sample(domain_poly, 400)
    test_pts  <- st_sample(domain_poly, 100)
    coords_train <- st_coordinates(train_pts)
    coords_test  <- st_coordinates(test_pts)

    train_df <- as.data.frame(raster::extract(all_stack, coords_train))
    test_df  <- as.data.frame(raster::extract(all_stack, coords_test))


    # Moran’s I
    nb        <- knn2nb(knearneigh(coords_train, k = 20))

    lw        <- nb2listw(nb, style="W")
    rep_df$Moran_I[rep] <- moran.test(train_df$Y, lw)$estimate[1]

  
    # Plain RF
    rf_model        <- randomForest(x=train_df[,c("X1","X2","X3")],
                                    y=train_df$Y, ntree=100)
    rep_df$MSE_RF[rep] <- mean((test_df$Y - predict(rf_model, test_df))^2)

    # RF-GLS
    rfgls_model     <- RFGLS_estimate_spatial(
      coords      = coords_train,
      y           = train_df$Y,
      X           = as.matrix(train_df[,c("X1","X2","X3")]),
      ntree       = 100,
      cov.model   = "matern",
      n.neighbors = 20,
      nu          = 1.5,
      sigma.sq    = psill,
      tau.sq      = sd_nug,
      phi         = 1/rho,
      verbose     = TRUE,h=15
    )
    rfgls_pred <- RFGLS_predict_spatial(rfgls_model, coords_test,
                                        as.matrix(test_df[,c("X1","X2","X3")]))$prediction
    rep_df$MSE_RFGLS[rep] <- mean((test_df$Y - rfgls_pred)^2)

    # Estimation MISE
    est_df <- data.frame(X1, X2, X3, true_mean=det_part)
    rep_df$MISE_RF[rep]    <- mean((predict(rf_model,    est_df) - est_df$true_mean)^2)
    rep_df$MISE_RFGLS[rep] <- mean((RFGLS_predict(rfgls_model, as.matrix(est_df[,1:3]))$predicted
                                    - est_df$true_mean)^2)
  }

  

  
  
  
  
  
  # Store scenario ID + parameters with the 50-rep data
  all_results[[i]] <- rep_df %>%
    mutate(
      set   = i,
      psill = psill,
      range = rho,
      sd_nug= sd_nug
    )
}

# Combine into one long data.frame
final_df <- bind_rows(all_results)


library(ggplot2)
# gather MSE metrics into long form
mse_long <- tidyr::pivot_longer(
  dplyr::select(final_df,
                set, psill, range, sd_nug, rep, MSE_RF, MSE_RFGLS),
  cols      = c(MSE_RF, MSE_RFGLS),
  names_to  = "method",
  values_to = "MSE"
)


mse_long <- final_df %>%
  select(set, psill, range, sd_nug, rep, MSE_RF, MSE_RFGLS) %>%
  pivot_longer(cols = c(MSE_RF, MSE_RFGLS),
               names_to = "method", values_to = "MSE")



# Same for MISE:
mise_long <- final_df %>%
  select(set, psill, range, sd_nug, rep, MISE_RF, MISE_RFGLS) %>%
  pivot_longer(cols = c(MISE_RF, MISE_RFGLS),
               names_to = "method", values_to = "MISE")
mise_long <- tidyr::pivot_longer(
  dplyr::select(final_df,
                set, psill, range, sd_nug, rep, MISE_RF, MISE_RFGLS),
  cols       = c(MISE_RF, MISE_RFGLS),
  names_to   = "method",
  values_to  = "MISE"
)




p <- ggplot(data, aes(x, y)) + geom_point()
ggsave("my_plot.png", plot = p, width = 8, height = 6)



mean(final_df$MISE_RF[1:50])
mean(final_df$MISE_RFGLS[1:50])
var(final_df$MISE_RF[1:50])
var(final_df$MISE_RFGLS[1:50])


mean(final_df$MISE_RF[51:100])
mean(final_df$MISE_RFGLS[51:100])
var(final_df$MSE_RF[51:100])
var(final_df$MSE_RFGLS[51:100])


mean(final_df$MSE_RF[101:150])
mean(final_df$MSE_RFGLS[101:150])
var(final_df$MSE_RF[101:150])
var(final_df$MSE_RFGLS[101:150])

mean(final_df$Moran_I[1:20])
mean(final_df$Moran_I[21:40])
mean(final_df$Moran_I[41:60])
```
[1] 0.1126855
[1] 0.2505845
[1] 0.3067868














